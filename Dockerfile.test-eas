# Match EAS Build ubuntu-22.04-jdk-17-ndk-r26b image
FROM ubuntu:jammy-v20250112

# Install Java 17 (same as EAS)
RUN apt-get update && apt-get install -y \
    openjdk-17-jdk \
    wget \
    unzip \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set JAVA_HOME to match EAS environment
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="$JAVA_HOME/bin:$PATH"

# Install Node.js 20.18.3 (same as EAS)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs=20.18.3-1nodesource1

# Install Android SDK to match EAS setup
ENV ANDROID_SDK_ROOT=/opt/android-sdk
ENV ANDROID_HOME=/opt/android-sdk
ENV PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools:${PATH}"

RUN mkdir -p ${ANDROID_SDK_ROOT}/cmdline-tools && \
    wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip && \
    unzip commandlinetools-linux-*_latest.zip -d ${ANDROID_SDK_ROOT}/cmdline-tools && \
    mv ${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools ${ANDROID_SDK_ROOT}/cmdline-tools/latest && \
    rm commandlinetools-linux-*_latest.zip

# Accept licenses and install required packages to match EAS
RUN yes | sdkmanager --licenses && \
    sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0" "ndk;26.1.10909125"

# Set working directory
WORKDIR /app

# Copy your project files
COPY package*.json ./
COPY .npmrc ./

# Install dependencies
RUN npm ci

# Copy rest of project
COPY . .

# Fix the Gradle versions that prebuild generates incorrectly
RUN sed -i "s/classpath('com.android.tools.build:gradle')/classpath('com.android.tools.build:gradle:8.1.4')/" android/build.gradle && \
    sed -i 's/gradle-8.13-bin.zip/gradle-8.4-bin.zip/' android/gradle/wrapper/gradle-wrapper.properties

# Test the exact failing command
CMD ["bash", "-c", "cd android && ./gradlew :app:bundleRelease --stacktrace"] 